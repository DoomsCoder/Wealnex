const { PrismaClient } = require("@prisma/client");

const prisma = new PrismaClient();

async function investigateRecurringTransactions() {
    console.log("\n========================================");
    console.log("    RECURRING TRANSACTIONS INVESTIGATION");
    console.log("========================================\n");

    // 1. Find all transactions marked as recurring (original recurring templates)
    const recurringTemplates = await prisma.transaction.findMany({
        where: {
            isRecurring: true,
        },
        include: {
            user: { select: { name: true, email: true } },
            account: { select: { name: true } },
        },
        orderBy: { createdAt: "asc" },
    });

    console.log("=== 1. RECURRING TRANSACTION TEMPLATES ===");
    console.log(`Found ${recurringTemplates.length} recurring transaction templates:\n`);

    recurringTemplates.forEach((t, index) => {
        console.log(`--- Template #${index + 1} ---`);
        console.log(`  ID: ${t.id}`);
        console.log(`  Description: ${t.description}`);
        console.log(`  Type: ${t.type}`);
        console.log(`  Amount: $${t.amount}`);
        console.log(`  Category: ${t.category}`);
        console.log(`  Interval: ${t.recurringInterval}`);
        console.log(`  Created At: ${t.createdAt}`);
        console.log(`  Next Recurring Date: ${t.nextRecurringDate}`);
        console.log(`  Last Processed: ${t.lastProcessed}`);
        console.log(`  User: ${t.user?.name} (${t.user?.email})`);
        console.log(`  Account: ${t.account?.name}`);
        console.log("");
    });

    // 2. Find all auto-generated recurring transactions (have "(Recurring)" in description)
    const autoGeneratedTransactions = await prisma.transaction.findMany({
        where: {
            description: {
                contains: "(Recurring)",
            },
        },
        include: {
            user: { select: { name: true, email: true } },
            account: { select: { name: true } },
        },
        orderBy: { createdAt: "desc" },
    });

    console.log("\n=== 2. AUTO-GENERATED RECURRING TRANSACTIONS ===");
    console.log(`Found ${autoGeneratedTransactions.length} auto-generated transactions:\n`);

    autoGeneratedTransactions.forEach((t, index) => {
        console.log(`--- Auto-Generated #${index + 1} ---`);
        console.log(`  ID: ${t.id}`);
        console.log(`  Description: ${t.description}`);
        console.log(`  Type: ${t.type}`);
        console.log(`  Amount: $${t.amount}`);
        console.log(`  Category: ${t.category}`);
        console.log(`  Date: ${t.date}`);
        console.log(`  Created At: ${t.createdAt}`);
        console.log(`  User: ${t.user?.name} (${t.user?.email})`);
        console.log(`  Account: ${t.account?.name}`);
        console.log("");
    });

    // 3. Calculate total amount of auto-generated transactions
    const totalAutoGenerated = autoGeneratedTransactions.reduce(
        (sum, t) => sum + parseFloat(t.amount),
        0
    );
    console.log(`\n=== 3. TOTAL AUTO-GENERATED AMOUNT ===`);
    console.log(`Total: $${totalAutoGenerated.toFixed(2)}\n`);

    // 4. Get budget info
    const budgets = await prisma.budget.findMany({
        include: {
            user: { select: { name: true, email: true } },
        },
    });

    console.log("\n=== 4. BUDGET INFORMATION ===");
    budgets.forEach((b) => {
        console.log(`  User: ${b.user?.name}`);
        console.log(`  Budget Amount: $${b.amount}`);
        console.log(`  Last Alert Sent: ${b.lastAlertSent}`);
        console.log(`  Updated At: ${b.updatedAt}`);
        console.log("");
    });

    // 5. Get all transactions from today (Jan 3, 2026)
    const today = new Date();
    const startOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const endOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);

    const todayTransactions = await prisma.transaction.findMany({
        where: {
            createdAt: {
                gte: startOfToday,
                lt: endOfToday,
            },
        },
        include: {
            user: { select: { name: true } },
            account: { select: { name: true } },
        },
        orderBy: { createdAt: "asc" },
    });

    console.log("\n=== 5. TRANSACTIONS CREATED TODAY ===");
    console.log(`Found ${todayTransactions.length} transactions created today:\n`);

    todayTransactions.forEach((t, index) => {
        console.log(`--- Today #${index + 1} ---`);
        console.log(`  Description: ${t.description}`);
        console.log(`  Type: ${t.type}`);
        console.log(`  Amount: $${t.amount}`);
        console.log(`  Created At: ${t.createdAt.toISOString()}`);
        console.log(`  Is Recurring Template: ${t.isRecurring}`);
        console.log("");
    });

    // 6. Summary
    console.log("\n========================================");
    console.log("            SUMMARY");
    console.log("========================================");
    console.log(`Recurring Templates: ${recurringTemplates.length}`);
    console.log(`Auto-Generated Transactions: ${autoGeneratedTransactions.length}`);
    console.log(`Total Auto-Generated Amount: $${totalAutoGenerated.toFixed(2)}`);
    console.log(`Transactions Created Today: ${todayTransactions.length}`);
    console.log("========================================\n");
}

investigateRecurringTransactions()
    .catch(console.error)
    .finally(() => prisma.$disconnect());
