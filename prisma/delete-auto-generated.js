const { PrismaClient } = require("@prisma/client");

const prisma = new PrismaClient();

async function deleteAutoGeneratedTransactions() {
    console.log("\n========================================");
    console.log("  DELETING AUTO-GENERATED TRANSACTIONS");
    console.log("========================================\n");

    // Find all transactions with "(Recurring)" in description (auto-generated ones)
    const autoGenerated = await prisma.transaction.findMany({
        where: {
            description: {
                contains: "(Recurring)",
            },
        },
        include: {
            account: { select: { name: true, id: true } },
        },
    });

    console.log(`Found ${autoGenerated.length} auto-generated transactions to delete:\n`);

    let totalExpenseAmount = 0;
    let totalIncomeAmount = 0;

    for (const t of autoGenerated) {
        const amount = parseFloat(t.amount);
        if (t.type === "EXPENSE") {
            totalExpenseAmount += amount;
        } else {
            totalIncomeAmount += amount;
        }
        console.log(`  - ${t.description}: $${t.amount} (${t.type})`);
    }

    console.log(`\nTotal EXPENSE to remove: $${totalExpenseAmount.toFixed(2)}`);
    console.log(`Total INCOME to remove: $${totalIncomeAmount.toFixed(2)}`);
    console.log(`Net balance adjustment: +$${(totalExpenseAmount - totalIncomeAmount).toFixed(2)}\n`);

    // Delete all auto-generated transactions and update account balances
    for (const t of autoGenerated) {
        const amount = parseFloat(t.amount);

        // Reverse the balance change
        const balanceAdjustment = t.type === "EXPENSE" ? amount : -amount;

        await prisma.$transaction([
            // Delete the transaction
            prisma.transaction.delete({
                where: { id: t.id },
            }),
            // Restore the account balance
            prisma.account.update({
                where: { id: t.accountId },
                data: { balance: { increment: balanceAdjustment } },
            }),
        ]);

        console.log(`âœ… Deleted: "${t.description}" and restored $${amount} to account`);
    }

    console.log("\n========================================");
    console.log(`Deleted ${autoGenerated.length} transactions.`);
    console.log("Account balances have been corrected.");
    console.log("========================================\n");
}

deleteAutoGeneratedTransactions()
    .catch(console.error)
    .finally(() => prisma.$disconnect());
